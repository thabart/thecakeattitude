<html>
	<head>		
		<meta charset="utf-8">
		<title>Cake attitude</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2" />
		<!-- Jquery -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
		<!-- Bootstrap -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/js/bootstrap.js"></script>
		<!-- Phaser lib -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.2/phaser.js"></script>
		<!-- Socket IO -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.js"></script>
		<!-- CSS Libraries -->
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.css">
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" >
		<style type="text/css">	
		</style>
	</head>
	<body>
		<div style="width:980px; margin: 0 auto;">
			<div id="game">
			
			</div>
			<div style="background-color: gray;">
				<div class="col-md-12">
					<form id="message-form">
						<input type="text" class="form-control" style="width: 300px; display:inline-block;" id="message-text" />
						<input type="submit" class="btn btn-default" style="display: inline-block;" id="send-message" value="Send"></input>
					</form>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		$(document).ready(function() {	
			// Speech bubble
			var SpeechBubble = function(game, x, y, width, text) {
				Phaser.Sprite.call(this, game, x, y);
				
				// Some sensible minimum defaults
				width = width || 27;
				var height = 18;
				
				// Set up our text and run our custom wrapping routine on it
				this.bitmapText = game.make.bitmapText(x + 12, y + 4, '8bitoperator', text, 14);
				SpeechBubble.wrapBitmapText(this.bitmapText, width);
				
				// Calculate the width and height needed for the edges
				var bounds = this.bitmapText.getLocalBounds();
				if (bounds.width + 18 > width) {
					width = bounds.width + 18;
				}
				if (bounds.height + 14 > height) {
					height = bounds.height + 14;
				}
				
				// Create all of our corners and edges
				this.borders = [
					game.make.tileSprite(x + 9, y + 9, width - 9, height - 9, 'bubble-border', 4),
					game.make.image(x, y, 'bubble-border', 0),
					game.make.image(x + width, y, 'bubble-border', 2),
					game.make.image(x + width, y + height, 'bubble-border', 8),
					game.make.image(x, y + height, 'bubble-border', 6),
					game.make.tileSprite(x + 9, y, width - 9, 9, 'bubble-border', 1),
					game.make.tileSprite(x + 9, y + height, width - 9, 9, 'bubble-border', 7),
					game.make.tileSprite(x, y + 9, 9, height - 9, 'bubble-border', 3),
					game.make.tileSprite(x + width, y + 9, 9, height - 9, 'bubble-border', 5)
				];  
				
				// Add all of the above to this sprite
				for (var b = 0, len = this.borders.length; b < len; b++) {
					this.addChild(this.borders[b]);   
				}

				// Add the tail
				this.tail = this.addChild(game.make.image(x + 18, y + 3 + height, 'bubble-tail'));

				// Add our text last so it's on top
				this.addChild(this.bitmapText);
				this.bitmapText.tint = 0x111111;
				
				// Offset the position to be centered on the end of the tail
				this.pivot.set(x + 25, y + height + 24);
			};

			SpeechBubble.prototype = Object.create(Phaser.Sprite.prototype);
			SpeechBubble.prototype.constructor = SpeechBubble;

			SpeechBubble.wrapBitmapText = function (bitmapText, maxWidth) {
				var words = bitmapText.text.split(' '), output = "", test = "";
				
				for (var w = 0, len = words.length; w < len; w++) {
					test += words[w] + " ";
					bitmapText.text = test;
					bitmapText.updateText();
					if (bitmapText.textWidth > maxWidth) {
						output += "\n" + words[w] + " ";
					}
					else {
						output += words[w] + " ";
					}
					test = output;
				}
				
				output = output.replace(/(\s)$/gm, ""); // remove trailing spaces
				bitmapText.text = output;
				bitmapText.updateText();
			};
		
			var Player = function(id, sprite) {
				this.id = id;
				this.sprite = sprite;
				this.direction = [];
				this.message = null;
				this.evtMessage = null;
				
				function updateDirection(dir, val) {
					var result = false;
					if (dir.isDown && this.direction.indexOf(val) == -1) {
						this.direction.push(val);
						result = true;
					} else if (dir.isUp && this.direction.indexOf(val) != -1) {
						this.direction.splice(this.direction.indexOf(val), 1);		
						result = true;
					}
					
					return result;
				}
				
				// Remove the player.
				this.remove = function() {
					this.sprite.destroy();
					if (this.message != null)
					{					
						this.message.destroy();
					}
				};				
				// Update direction.
				// Returns : true if the direction changes.
				this.updateDirection = function(cursors) {
					var result = false;
					result = result || updateDirection.call(this, cursors.up, 0);
					result = result || updateDirection.call(this, cursors.right, 1);
					result = result || updateDirection.call(this, cursors.down, 2);
					result = result || updateDirection.call(this, cursors.left, 3);
					return result;
				};				
				// Update the properties.
				this.update = function(x, y, direction) {
					this.sprite.x = x;
					this.sprite.y = y;
					this.direction = direction;
				};				
				// Display message
				this.displayMessage = function(message, evtMessage) {
					this.message = message;
					this.evtMessage = evtMessage;
				};				
				// Destroy the message.
				this.destroyMessage = function() {
					if (this.message == null) {
						return;
					}
					
					this.message.destroy();
					this.message = null;
					this.evtMessage = null;					
				};				
				// Update player position.
				this.updatePosition = function() {					
					this.sprite.body.velocity.x = 0;
					this.sprite.body.velocity.y = 0;
					if (this.direction.indexOf(0) != -1) {						
						this.sprite.body.velocity.y = -200;
					} else if (this.direction.indexOf(2) != -1) {			
						this.sprite.body.velocity.y = 200;						
					}
					
					if (this.direction.indexOf(1) != -1) {	
						this.sprite.body.velocity.x = 200;
					} else if (this.direction.indexOf(3) != -1) {			
						this.sprite.body.velocity.x = -200;						
					}
				};				
				// Update message position.
				this.updateMessagePosition = function() {
					if (this.message == null) {
						return;
					}
					
					this.message.x = Math.floor(this.sprite.x + (this.sprite.width / 2));
					this.message.y = Math.floor(this.sprite.y);				
				};				
				// Reset the direction.
				this.resetDirection = function() {
					this.direction = [];
				};
			}
		
			var Map = function(tileMap, game) {
				this.tileMap = tileMap;		
				this.wraps = [];
				this.player = null;
				this.players = [];
				this.layers = {
					alimentation : null,
					earth : null,
					ground: null,
					collision : null					
				};
				
				this.init = function() {
					// TODO : Load all the IMAGES.
					this.tileMap.addTilesetImage('tallgrass', 'tallgrass');
					this.tileMap.addTilesetImage('farming_fishing', 'farming_fishing');
					this.tileMap.addTilesetImage('tiles', 'tiles');
					// Load the WRAPS.
					this.wraps = game.add.group();
					this.wraps.enableBody = true;
					this.tileMap.createFromObjects('Wraps', 'wrap', 'wrap', 0, true, false, this.wraps);		
					// Add layers.					
					this.layers.collision = this.tileMap.createLayer('Collision');
					this.layers.ground = this.tileMap.createLayer('Ground');
					this.layers.earth = this.tileMap.createLayer('Earth');
					this.layers.alimentation = this.tileMap.createLayer('Alimentations');
					// Specify which tile can collide.
					this.tileMap.setCollision(421, true, 'Collision');
					// Add the player to the world.
					this.player = new Player(null, game.add.sprite(0, 0, 'player'));
					game.physics.arcade.enable(this.player.sprite);			
					// Make the camera follow the sprite.
					game.camera.follow(this.player.sprite, Phaser.Camera.FOLLOW_LOCKON, 0.1, 0.1);	
					// Display layer.
					this.layers.earth.resizeWorld();
				};
				
				this.destroy = function() {
					// Destroy the layers & objects.
					this.layers.collision.destroy();
					this.layers.ground.destroy();
					this.layers.earth.destroy();
					this.layers.alimentation.destroy();
					this.wraps.destroy();
					this.tileMap.destroy();
					this.player.remove();
					this.players.forEach(function(p) {
						p.remove();
					});
				};
			};
			
			var canvas = function(opts) {			
				this.fields = {
					game: null,
					map: null,
					cursors: null
				};
					
				function preload() {
					// TODO : Load all the assets from the configuration endpoint.
					this.fields.game.load.tilemap('firstMap', 'http://localhost:3000/public/map/map.json', null, Phaser.Tilemap.TILED_JSON);
					this.fields.game.load.tilemap('secondMap', 'http://localhost:3000/public/map/map2.json', null, Phaser.Tilemap.TILED_JSON);
					this.fields.game.load.image('tallgrass', 'http://localhost:3000/public/map/tilesets/tallgrass.png');
					this.fields.game.load.image('farming_fishing', 'http://localhost:3000/public/map/tilesets/farming_fishing.png');
					this.fields.game.load.image('tiles', 'http://localhost:3000/public/map/tilesets/tiles.png');
					this.fields.game.load.image('player', 'http://localhost:3000/public/map/character/phaser-dude.png');
					this.fields.game.load.spritesheet('bubble-border', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAbAgMAAADwuhzGAAAADFBMVEUAAAD///8AAADMzMyl8w72AAAAAXRSTlMAQObYZgAAADlJREFUCNdjYGDQWrWqgQGT5poaGpqFSTMtDQWCFRj0PyrR/3+B7cGgmf+/AroLk2bg////AwMGDQCR0FKxG5KiwAAAAABJRU5ErkJggg==', 9, 9);
					this.fields.game.load.image('bubble-tail', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAVAgMAAADUeU0FAAAADFBMVEUAAAAAAAD////MzMyoZCTaAAAAAXRSTlMAQObYZgAAAC1JREFUCNdjCA3NWrXUAY36/xULxYyN+hu1amUAAyYVwoBBhYYyYFDh/w9gUADQUTeozcOYAwAAAABJRU5ErkJggg==');
					this.fields.game.load.bitmapFont('8bitoperator', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACAAQMAAAD58POIAAAABlBMVEUAAAD///+l2Z/dAAAAAXRSTlMAQObYZgAABF9JREFUSMftlEur00AUx6cI0UXqxd0UpXXh0sWEgShYLCgIih9iSmC6SW/FC1Kx1kdFXRTrzoZC1W8gBLrxlVBINxOzkwbxUQJ1c9WWQL0XveqZpFyrH0E8q5nfnMd/zpkEEebeua2eOHGC5Hp6pUVQvRyJIL++vo61nm56GIlYr1g2Sk11EMp05arIi8V6HIvcM3TZmlYe9jmY38u0c10kHM8cU37pN2AJaKYgBEASsC7BRAK/65nvKefNpv8tc6eTgNq4tEx6HWqKmQxZgtZu0iKAy73YWysm0t/b6G9TxVDrM7hoG+W6jKsKFgalrD6PBNK6jqGo0ivf8OG+y5CmmH+8zmUs8nvkS9hnfo/muZhHbQnMnC0BBSXaKtjD/a52fQkaAArct+ZtdLlHapbNrkJIIwnRpMdLlgUAcRCi7eYosMY8dgDoAJp10JFKIvMoCGiydBiH66emrClMMMcAUC+H4RvdyLWZAB84E/HGxobOctcJmn8YdY4jP4lSx5RA0WQMmWgyiURoY4FTEFNKdVOC7XjtvRwDAGIGVAVtKsbIt6TLpiOBrsrJfUtCPKqI7cXeThFdbklQEQWlkWrMWbE2iT7I5Z4pnXGkzhJeuPPowFDXywtYs2H5JyUiig19wBgSjnubEkqFZxi6PZzCsCGYXBv43mQ0GCgcnmH0aoNQPRhFLd32OLoQ65yepPqrEY/1AefQQgAzmYMblCfg2JSSa08OBZ4RGZAUPBSoUnhwd88TBJaGlGiilJj4MNKsKKjDDWy+0wJAUH0GlT9uhjbPtugXSza0uB1rbQliaFwbNW/ypLt9noMZvlHQwoNXcKMdtouatTDfqWjxmfldFzxwuQseGC1+bG3PypADuxASPkGXXjMXcgQUu1a0GT5CupcAj+KdpHcAuGtN7iSPI6/sbAH47nZB241o1KH7HQwAjijXWnKceQBgnxUAUmZL3yJo61umBSDT07PuPa4SJD+sNfDoVYLhHq6yBOT6vNzT1z3aFBLszcBX6UIOAQNferQbPlQZ55V6CtZKzG8Zo4dSXVpFZfVE6SHnDHIOgg7YxATaSBwBAO50srnTI6BUm3dl94MOZS6At3ZjiFF9PoUj5rZI9aFNPAxV9AQ8ndUO2mSYgjFtbPdI1bKJKx+uXutCDuBplfpWZXO8BH1y4QwS2JM5nJiKUCqFEMUMXzQdud7byfPkH9SBTSngxwRMGKYvD4tlXh0MTBcAGDXrpwwFQC0A8PF5Z8O8ZSmlT+CRA1B+4tHsxccqzwII7SIATrPnHmNetXml08cJyFy0SMm3OUNgElTPnTKQtH3VQQLMW8XT6pAb+w8twVHoqFIeDg/qR+7LKlfOI+wZx+adN8bZw+jrcxCuYuFJD5Ta2nsV5doyh9yJ+ZSFL5uqszyVLSxbbaSwXdCiQ6ziXQck4sxtjFbBQSpwCRYrOWpj1PgNGlAFFdAfpnjOym4nHpjmKlAVCFm17Az9t3/TfgG1wI+/NyjOhQAAAABJRU5ErkJggg==', null, '<?xml version="1.0"?><font><info face="8bitoperator" size="11" bold="0" italic="0" charset="" unicode="1" stretchH="100" smooth="0" aa="0" padding="0,0,0,0" spacing="1,1" outline="0"/><common lineHeight="16" base="13" scaleW="128" scaleH="128" pages="1" packed="0" alphaChnl="0" redChnl="4" greenChnl="4" blueChnl="4"/><pages><page id="0" file="8bitoperator.png" /></pages><chars count="179"><char id="32" x="124" y="23" width="1" height="1" xoffset="0" yoffset="0" xadvance="6" page="0" chnl="15" /><char id="33" x="124" y="13" width="2" height="9" xoffset="1" yoffset="4" xadvance="4" page="0" chnl="15" /><char id="34" x="113" y="84" width="5" height="4" xoffset="1" yoffset="4" xadvance="7" page="0" chnl="15" /><char id="35" x="49" y="38" width="8" height="9" xoffset="1" yoffset="4" xadvance="10" page="0" chnl="15" /><char id="36" x="7" y="0" width="6" height="13" xoffset="1" yoffset="2" xadvance="8" page="0" chnl="15" /><char id="37" x="57" y="78" width="7" height="8" xoffset="1" yoffset="5" xadvance="9" page="0" chnl="15" /><char id="38" x="85" y="37" width="7" height="9" xoffset="1" yoffset="4" xadvance="9" page="0" chnl="15" /><char id="39" x="122" y="84" width="2" height="4" xoffset="1" yoffset="4" xadvance="4" page="0" chnl="15" /><char id="40" x="123" y="66" width="4" height="9" xoffset="1" yoffset="4" xadvance="6" page="0" chnl="15" /><char id="41" x="15" y="80" width="4" height="9" xoffset="1" yoffset="4" xadvance="6" page="0" chnl="15" /><char id="42" x="77" y="85" width="7" height="5" xoffset="1" yoffset="6" xadvance="9" page="0" chnl="15" /><char id="43" x="92" y="85" width="6" height="5" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="44" x="119" y="84" width="2" height="4" xoffset="1" yoffset="11" xadvance="4" page="0" chnl="15" /><char id="45" x="49" y="95" width="5" height="1" xoffset="1" yoffset="8" xadvance="7" page="0" chnl="15" /><char id="46" x="125" y="84" width="2" height="2" xoffset="1" yoffset="11" xadvance="4" page="0" chnl="15" /><char id="47" x="101" y="25" width="6" height="10" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="48" x="84" y="57" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="49" x="25" y="79" width="4" height="9" xoffset="1" yoffset="4" xadvance="6" page="0" chnl="15" /><char id="50" x="91" y="57" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="51" x="98" y="56" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="52" x="105" y="56" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="53" x="112" y="56" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="54" x="77" y="57" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="55" x="119" y="56" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="56" x="0" y="70" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="57" x="7" y="70" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="58" x="56" y="87" width="2" height="7" xoffset="1" yoffset="6" xadvance="4" page="0" chnl="15" /><char id="59" x="33" y="79" width="2" height="9" xoffset="1" yoffset="6" xadvance="4" page="0" chnl="15" /><char id="60" x="117" y="66" width="5" height="9" xoffset="1" yoffset="4" xadvance="7" page="0" chnl="15" /><char id="61" x="7" y="98" width="5" height="3" xoffset="1" yoffset="7" xadvance="7" page="0" chnl="15" /><char id="62" x="122" y="46" width="5" height="9" xoffset="1" yoffset="4" xadvance="7" page="0" chnl="15" /><char id="63" x="14" y="70" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="64" x="58" y="37" width="8" height="9" xoffset="1" yoffset="4" xadvance="10" page="0" chnl="15" /><char id="65" x="21" y="69" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="66" x="28" y="69" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="67" x="35" y="69" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="68" x="42" y="68" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="69" x="49" y="68" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="70" x="56" y="68" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="71" x="63" y="67" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="72" x="70" y="67" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="73" x="20" y="80" width="4" height="9" xoffset="1" yoffset="4" xadvance="6" page="0" chnl="15" /><char id="74" x="77" y="67" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="75" x="84" y="67" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="76" x="14" y="60" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="77" x="8" y="50" width="7" height="9" xoffset="1" yoffset="4" xadvance="9" page="0" chnl="15" /><char id="78" x="91" y="67" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="79" x="98" y="66" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="80" x="24" y="49" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="81" x="0" y="27" width="6" height="11" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="82" x="31" y="49" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="83" x="38" y="48" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="84" x="45" y="48" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="85" x="52" y="48" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="86" x="59" y="47" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="87" x="101" y="36" width="7" height="9" xoffset="1" yoffset="4" xadvance="9" page="0" chnl="15" /><char id="88" x="66" y="47" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="89" x="73" y="47" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="90" x="80" y="47" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="91" x="10" y="80" width="4" height="9" xoffset="1" yoffset="4" xadvance="6" page="0" chnl="15" /><char id="92" x="73" y="26" width="6" height="10" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="93" x="5" y="80" width="4" height="9" xoffset="1" yoffset="4" xadvance="6" page="0" chnl="15" /><char id="94" x="105" y="84" width="7" height="4" xoffset="1" yoffset="3" xadvance="9" page="0" chnl="15" /><char id="95" x="43" y="96" width="5" height="1" xoffset="0" yoffset="14" xadvance="5" page="0" chnl="15" /><char id="96" x="32" y="97" width="3" height="2" xoffset="1" yoffset="3" xadvance="5" page="0" chnl="15" /><char id="97" x="107" y="76" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="98" x="87" y="47" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="99" x="14" y="90" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="100" x="101" y="46" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="101" x="100" y="76" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="102" x="105" y="66" width="5" height="9" xoffset="1" yoffset="4" xadvance="7" page="0" chnl="15" /><char id="103" x="109" y="36" width="7" height="9" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="104" x="108" y="46" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="105" x="122" y="25" width="4" height="10" xoffset="1" yoffset="3" xadvance="6" page="0" chnl="15" /><char id="106" x="21" y="14" width="6" height="12" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="107" x="115" y="46" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="108" x="0" y="80" width="4" height="9" xoffset="1" yoffset="4" xadvance="6" page="0" chnl="15" /><char id="109" x="76" y="77" width="8" height="7" xoffset="1" yoffset="6" xadvance="10" page="0" chnl="15" /><char id="110" x="93" y="77" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="111" x="114" y="76" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="112" x="0" y="60" width="6" height="9" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="113" x="7" y="60" width="6" height="9" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="114" x="35" y="89" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="115" x="7" y="90" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="116" x="111" y="66" width="5" height="9" xoffset="1" yoffset="4" xadvance="7" page="0" chnl="15" /><char id="117" x="0" y="90" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="118" x="121" y="76" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="119" x="85" y="77" width="7" height="7" xoffset="1" yoffset="6" xadvance="9" page="0" chnl="15" /><char id="120" x="21" y="90" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="121" x="94" y="46" width="6" height="9" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="122" x="28" y="89" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="123" x="21" y="59" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="124" x="30" y="79" width="2" height="9" xoffset="1" yoffset="4" xadvance="4" page="0" chnl="15" /><char id="125" x="28" y="59" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="126" x="13" y="98" width="7" height="2" xoffset="1" yoffset="7" xadvance="9" page="0" chnl="15" /><char id="160" x="126" y="56" width="1" height="1" xoffset="0" yoffset="0" xadvance="6" page="0" chnl="15" /><char id="161" x="125" y="36" width="2" height="9" xoffset="1" yoffset="6" xadvance="4" page="0" chnl="15" /><char id="162" x="35" y="59" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="163" x="16" y="49" width="7" height="9" xoffset="1" yoffset="4" xadvance="9" page="0" chnl="15" /><char id="165" x="42" y="58" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="166" x="36" y="79" width="2" height="9" xoffset="1" yoffset="4" xadvance="4" page="0" chnl="15" /><char id="168" x="21" y="98" width="6" height="2" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="169" x="48" y="78" width="8" height="8" xoffset="1" yoffset="5" xadvance="10" page="0" chnl="15" /><char id="171" x="59" y="87" width="8" height="5" xoffset="1" yoffset="6" xadvance="10" page="0" chnl="15" /><char id="172" x="0" y="98" width="6" height="3" xoffset="1" yoffset="8" xadvance="8" page="0" chnl="15" /><char id="174" x="39" y="79" width="8" height="8" xoffset="1" yoffset="5" xadvance="10" page="0" chnl="15" /><char id="176" x="99" y="85" width="5" height="5" xoffset="1" yoffset="3" xadvance="7" page="0" chnl="15" /><char id="177" x="42" y="88" width="6" height="7" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="180" x="28" y="97" width="3" height="2" xoffset="1" yoffset="3" xadvance="5" page="0" chnl="15" /><char id="181" x="49" y="58" width="6" height="9" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="182" x="0" y="50" width="7" height="9" xoffset="1" yoffset="4" xadvance="9" page="0" chnl="15" /><char id="183" x="40" y="97" width="2" height="2" xoffset="1" yoffset="7" xadvance="4" page="0" chnl="15" /><char id="184" x="36" y="97" width="3" height="2" xoffset="1" yoffset="13" xadvance="5" page="0" chnl="15" /><char id="187" x="68" y="85" width="8" height="5" xoffset="1" yoffset="6" xadvance="10" page="0" chnl="15" /><char id="191" x="56" y="58" width="6" height="9" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="192" x="73" y="0" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="193" x="42" y="14" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="194" x="42" y="0" width="6" height="13" xoffset="1" yoffset="0" xadvance="8" page="0" chnl="15" /><char id="195" x="65" y="0" width="7" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="196" x="87" y="0" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="197" x="28" y="0" width="6" height="13" xoffset="1" yoffset="0" xadvance="8" page="0" chnl="15" /><char id="198" x="38" y="38" width="10" height="9" xoffset="1" yoffset="4" xadvance="12" page="0" chnl="15" /><char id="199" x="108" y="0" width="6" height="12" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="200" x="28" y="14" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="201" x="49" y="13" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="202" x="35" y="0" width="6" height="13" xoffset="1" yoffset="0" xadvance="8" page="0" chnl="15" /><char id="203" x="94" y="0" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="204" x="122" y="0" width="4" height="12" xoffset="1" yoffset="1" xadvance="6" page="0" chnl="15" /><char id="205" x="77" y="13" width="4" height="12" xoffset="1" yoffset="1" xadvance="6" page="0" chnl="15" /><char id="206" x="14" y="0" width="6" height="13" xoffset="0" yoffset="0" xadvance="6" page="0" chnl="15" /><char id="207" x="101" y="0" width="6" height="12" xoffset="0" yoffset="1" xadvance="6" page="0" chnl="15" /><char id="208" x="93" y="36" width="7" height="9" xoffset="0" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="209" x="57" y="0" width="7" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="210" x="63" y="13" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="211" x="80" y="0" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="212" x="0" y="0" width="6" height="13" xoffset="1" yoffset="0" xadvance="8" page="0" chnl="15" /><char id="213" x="49" y="0" width="7" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="214" x="70" y="13" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="215" x="85" y="85" width="6" height="5" xoffset="1" yoffset="7" xadvance="8" page="0" chnl="15" /><char id="216" x="67" y="37" width="8" height="9" xoffset="0" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="217" x="35" y="14" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="218" x="14" y="14" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="219" x="21" y="0" width="6" height="13" xoffset="1" yoffset="0" xadvance="8" page="0" chnl="15" /><char id="220" x="7" y="14" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="221" x="0" y="14" width="6" height="12" xoffset="1" yoffset="1" xadvance="8" page="0" chnl="15" /><char id="222" x="63" y="57" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="223" x="70" y="57" width="6" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="224" x="87" y="25" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="225" x="94" y="25" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="226" x="110" y="13" width="6" height="11" xoffset="1" yoffset="2" xadvance="8" page="0" chnl="15" /><char id="227" x="14" y="27" width="7" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="228" x="45" y="27" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="229" x="82" y="13" width="6" height="11" xoffset="1" yoffset="2" xadvance="8" page="0" chnl="15" /><char id="230" x="65" y="77" width="10" height="7" xoffset="1" yoffset="6" xadvance="12" page="0" chnl="15" /><char id="231" x="59" y="26" width="6" height="10" xoffset="1" yoffset="6" xadvance="8" page="0" chnl="15" /><char id="232" x="108" y="25" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="233" x="21" y="38" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="234" x="7" y="27" width="6" height="11" xoffset="1" yoffset="2" xadvance="8" page="0" chnl="15" /><char id="235" x="115" y="25" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="236" x="33" y="38" width="4" height="10" xoffset="1" yoffset="3" xadvance="6" page="0" chnl="15" /><char id="237" x="28" y="38" width="4" height="10" xoffset="1" yoffset="3" xadvance="6" page="0" chnl="15" /><char id="238" x="117" y="13" width="6" height="11" xoffset="0" yoffset="2" xadvance="6" page="0" chnl="15" /><char id="239" x="0" y="39" width="6" height="10" xoffset="0" yoffset="3" xadvance="6" page="0" chnl="15" /><char id="240" x="117" y="36" width="7" height="9" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="241" x="22" y="27" width="7" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="242" x="7" y="39" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="243" x="14" y="38" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="244" x="103" y="13" width="6" height="11" xoffset="1" yoffset="2" xadvance="8" page="0" chnl="15" /><char id="245" x="30" y="27" width="7" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="246" x="38" y="27" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="247" x="49" y="87" width="6" height="7" xoffset="1" yoffset="5" xadvance="8" page="0" chnl="15" /><char id="248" x="76" y="37" width="8" height="9" xoffset="0" yoffset="5" xadvance="8" page="0" chnl="15" /><char id="249" x="52" y="26" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="250" x="66" y="26" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="251" x="96" y="13" width="6" height="11" xoffset="1" yoffset="2" xadvance="8" page="0" chnl="15" /><char id="252" x="80" y="26" width="6" height="10" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="253" x="115" y="0" width="6" height="12" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /><char id="254" x="89" y="13" width="6" height="11" xoffset="1" yoffset="4" xadvance="8" page="0" chnl="15" /><char id="255" x="56" y="13" width="6" height="12" xoffset="1" yoffset="3" xadvance="8" page="0" chnl="15" /></chars></font>');
				};
				
				function create() {	
					// Start the Arcade physics systems.
					this.fields.game.physics.startSystem(Phaser.Physics.ARCADE);
					// Change background color.				
					this.fields.game.stage.backgroundColor = '#787878';
					// Keep running on losing focus
					this.fields.game.stage.disableVisibilityChange = true;
					// Add tile map and tile set image.
					var tileMap = this.fields.game.add.tilemap('firstMap');
					this.fields.map = new Map(tileMap, this.fields.game);		
					this.fields.map.init();
					this.fields.cursors = this.fields.game.input.keyboard.createCursorKeys();	
					if (opts && opts.createCallback) {
						opts.createCallback();
					}
				}
							
				function update() {
					var self = this;
					this.fields.map.players.forEach(function(p) {
						if (!self.fields.game.physics.arcade.collide(p.sprite, self.fields.map.layers.collision)) {
							p.updatePosition();		
							p.updateMessagePosition();						
						}
					});
					
					if (self.fields.game.physics.arcade.collide(self.fields.map.player.sprite, self.fields.map.layers.collision)) {
						return;
					}
					
					if (self.fields.game.physics.arcade.overlap(self.fields.map.player.sprite, self.fields.map.wraps, function(e, wrap) {
						// TODO : Load an another map.
						var map = wrap.map;
						var tileMap = self.fields.game.add.tilemap(map);
						self.fields.map.destroy();
						self.fields.map = new Map(tileMap, self.fields.game);
						self.fields.map.init();
					})) {
						return;
					}
					
					// Update player.
					isPositionUpdated = this.fields.map.player.updateDirection(this.fields.cursors);
					this.fields.map.player.updatePosition();	
					this.fields.map.player.updateMessagePosition();
					
					if (isPositionUpdated && opts && opts.updateCallback) {
						opts.updateCallback(this.fields.map.player);
					}
				}
				
				function getPlayer(id) {
					var i;
					for (i = 0; i < this.fields.map.players.length; i++) {
						if (this.fields.map.players[i].id === id) {
							return this.fields.map.players[i];
						}
					}
				
					return false
				}
				
				// Initialize the game.
				this.init = function() {
					var self = this;
					this.fields.game = new Phaser.Game(980, 600, Phaser.AUTO, 'game', { preload : function() { preload.call(self); }, create : function() { create.call(self); }, update : function() { update.call(self); } });
				};
				// Display message.
				this.displayMessage = function(txt, id) {
					var player = this.fields.map.player;
					if (id) {
						player = getPlayer.call(this, id);
					}
					
					// 1. Destroy the message.
					if (player.evtMessage != null) {
						this.fields.game.time.events.remove(player.evtMessage);
					}
					
					player.destroyMessage();					
					var speechBubble = new SpeechBubble(this.fields.game, player.sprite.x + (player.sprite.width / 2), player.sprite.y, 150, txt);
					this.fields.game.world.add(speechBubble);
					var evtMessage = this.fields.game.time.events.add(Phaser.Timer.SECOND * 5, function() {
						player.destroyMessage();
					}, this);
					player.displayMessage(speechBubble, evtMessage);
				};
				// Clean the players.
				this.cleanPlayers = function() {
					this.fields.map.players.forEach(function(player) {
						player.remove();
					});
					
					this.fields.map.players = [];
				};
				// Add a new player to the map.
				this.addPlayer = function(id, x, y, direction) {
					var newPlayer = this.fields.game.add.sprite(x, y, 'player');
					this.fields.game.physics.enable(newPlayer, Phaser.Physics.ARCADE)
					var newPlayer = new Player(id, newPlayer);
					newPlayer.direction = direction;
					this.fields.map.players.push(newPlayer);
				};
				// Remove the player from the map.
				this.removePlayer = function(id) {
					var player = getPlayer.call(this, id);
					if (!player) {
						return;
					}
					
					player.remove();
					this.fields.players.splice(this.fields.map.players.indexOf(player), 1);						
				};
				// Update the player position.
				this.updatePlayer = function(id, x, y, direction) {
					var player = getPlayer.call(this, id);
					if (!player) {
						return;
					}
					
					player.update(x, y, direction);
				};
			};
			
			var socketProxy = function(opts) {
				this.socket = null;
				
				function onSocketConnected() {
					console.log('Connected to socket server');					
				}
			
				this.init = function() {					
					this.socket = io('http://localhost:3001').connect();
					this.socket.on('connect', function() {
						console.log('socket connected');
						if (opts && opts.socketConnectedCallback) {
							opts.socketConnectedCallback();
						}
					});
					this.socket.on('disconnect', function() {
						console.log('socket disconnected');
					});
					this.socket.on('new_player', function(data) {
						console.log('new player');
						if (opts && opts.newPlayerCallback) {
							opts.newPlayerCallback(data);
						}
					});
					this.socket.on('remove_player', function(data) {
						console.log('remove player');
						if (opts && opts.removePlayerCallback) {
							opts.removePlayerCallback(data);
						}
					});
					this.socket.on('move_player', function(data) {
						if (opts && opts.movePlayerCallback) {
							opts.movePlayerCallback(data);
						}
					});
					this.socket.on('message', function(data) {
						if (opts && opts.messageCallback) {
							opts.messageCallback(data);
						}
					});
				};
				// Send a message to connect the player.
				this.newPlayer = function(x, y, direction) {
					this.socket.emit('new_player', { x : x, y : y, direction : direction });
				};
				// Send a message to update the player position.
				this.updatePlayer = function(x, y, direction) {
					this.socket.emit('move_player', {x : x, y : y, direction : direction });
				};
				// Send a message
				this.sendMessage = function(message) {
					this.socket.emit('message', { message : message });
				};
			};
			
			var proxy = new socketProxy({
				socketConnectedCallback : function() {
					// Clean all the players.
					c.cleanPlayers();
					// Send a message to connect the player.
					proxy.newPlayer(c.fields.map.player.sprite.x, c.fields.map.player.sprite.y, c.fields.map.player.direction);
				},
				newPlayerCallback: function(data) {
					c.addPlayer(data.id, data.x, data.y, data.direction);
				},
				removePlayerCallback: function(data) {
					c.removePlayer(data.id);
				},
				movePlayerCallback: function(data) {
					c.updatePlayer(data.id, data.x, data.y, data.direction);					
				},
				messageCallback: function(data) {
					c.displayMessage(data.message, data.id);
				}
			});
			var c = new canvas({
				createCallback: function() {
					proxy.init();
				},
				updateCallback: function(p) {
					proxy.updatePlayer(p.sprite.x, p.sprite.y, p.direction);
				}
			});
			c.init();
			
			// Send message.
			$("#message-form").submit(function(e) {
				e.preventDefault();
				var txt = $("#message-text").val();
				c.displayMessage(txt);
				proxy.sendMessage(txt);
				$("#message-text").val('');
			});			
			
		});
	</script>
</html>